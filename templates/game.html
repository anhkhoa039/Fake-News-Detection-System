<!DOCTYPE html>
<html>
<head>
    <title>üîç fakeoff - AI-Powered Fake News Detection</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap');
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Poppins', sans-serif;
            padding: 20px;
            position: relative;
            overflow-x: hidden;
        }
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: url("{{ url_for('static', filename='bg.jpg') }}") center/cover;
            opacity: 0.1;
            z-index: -1;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .header {
            text-align: center;
            margin-bottom: 40px;
            animation: fadeInDown 1s ease-out;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 30px;
            border-radius: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .header h1 { color: white; font-size: 3rem; font-weight: 700; margin-bottom: 10px; text-shadow: 2px 2px 8px rgba(0,0,0,0.7); }
        .header p { color: rgba(255,255,255,0.95); font-size: 1.2rem; font-weight: 300; text-shadow: 1px 1px 4px rgba(0,0,0,0.5); }
        .nav-bar {
            display: flex; justify-content: center; gap: 15px; margin-bottom: 40px;
            flex-wrap: wrap; position: sticky; top: 20px; z-index: 100;
        }
        .nav-bar a {
            text-decoration: none;
            padding: 12px 20px;
            background: rgba(0,0,0,0.7);
            color: white;
            border-radius: 25px;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.3);
            font-weight: 500;
            position: relative;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .nav-bar a:hover { background: rgba(0,0,0,0.8); }
        .nav-bar a.active { background: rgba(102, 126, 234, 0.9); border: 2px solid rgba(102, 126, 234, 1); }
        .main-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 60vh;
        }
        .game-card {
            background: rgba(255, 255, 255, 0.98);
            padding: 40px 24px 24px 24px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.13);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
            width: 100%; max-width: 720px;
        }
        .news-item {
            min-height: 150px;
            max-width: 90%;
            margin: 0 auto 2em auto;
            font-size: 1.15em;
            word-break: break-word;
        }
        @keyframes fadeInDown {
            from { opacity: 0; transform: translateY(-30px); }
            to   { opacity: 1; transform: translateY(0); }
        }
    </style>
    <!-- Plus Tailwind for inner quiz style -->
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-shield-alt"></i> fakeoff</h1>
            <p>AI-Powered Fake News Detection System</p>
        </div>
        <div class="nav-bar">
            <a href="{{ url_for('home') }}" class="{% if request.endpoint == 'home' %}active{% endif %}"><i class="fas fa-home"></i> Home</a>
            <a href="{{ url_for('history') }}" class="{% if request.endpoint == 'history' %}active{% endif %}"><i class="fas fa-history"></i> History</a>
            <a href="{{ url_for('visualization') }}" class="{% if request.endpoint == 'visualization' %}active{% endif %}"><i class="fas fa-chart-bar"></i> Analytics</a>
            <a href="{{ url_for('game') }}" class="active"><i class="fas fa-gamepad"></i> Game Mode</a>
            {% if session.get('role') == 'admin' %}
            <a href="{{ url_for('admin') }}" class="{% if request.endpoint == 'admin' %}active{% endif %}"><i class="fas fa-cog"></i> Dashboard</a>
            {% endif %}
            <a href="{{ url_for('logout') }}"><i class="fas fa-sign-out-alt"></i> Logout</a>
        </div>
        <div class="main-content">
            <div class="game-card">
                <!-- Game app content rendered here -->
                <div id="app"></div>
            </div>
        </div>
    </div>
    <!-- Game app logic below - from previous game.html, demo mode patch -->
    <script type="module">
        // Use backend-provided NEWS_DATA
        var NEWS_DATA = {{ news_data | tojson }};

        // App state
        let state = {
            gameState: 'loading', // 'loading', 'welcome', 'testing', 'results', 'history'
            testItems: [],
            currentQuestionIndex: 0,
            startTime: 0,
            totalTestStartTime: 0,
            results: [],
            scoreHistory: [],
            error: null,
            loading: true
        };
        const appDiv = document.getElementById('app');
        // Utility
        function formatTime(ms) {
            const totalSeconds = ms / 1000;
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = Math.floor(totalSeconds % 60);
            const milliseconds = Math.floor((ms % 1000) / 10);
            const pad = (num, size = 2) => String(num).padStart(size, '0');
            return `${pad(minutes)}:${pad(seconds)}.${pad(milliseconds)}`;
        }
        function shuffleArray(array) {
            let shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }
        function generateTestItems(count = 10) {
            const filtered = shuffleArray(NEWS_DATA).filter(
                item => item && typeof item.headline === 'string' && item.headline.trim().length > 0
            );
            if (filtered.length === 0) {
                alert("No quiz data available ‚Äî check your backend CSV or filtering.");
                state.testItems = [];
                return;
            }
            if (filtered.length < 10) {
                alert("Warning: Only " + filtered.length + " valid quiz questions available. Game will be shorter!");
            }
            state.testItems = filtered.slice(0, Math.min(filtered.length, count)).map(item => ({
                id: item.id,
                headline: item.headline,
                isReal: item.isReal
            }));
        }
        // Game Logic
        function startTest() {
            generateTestItems(10);
            state.currentQuestionIndex = 0;
            state.results = [];
            state.totalTestStartTime = Date.now();
            state.startTime = Date.now();
            state.gameState = 'testing';
            render();
        }
        function handleAnswer(userChoice) {
            if (state.gameState !== 'testing') return;
            const currentItem = state.testItems[state.currentQuestionIndex];
            const timeTaken = Date.now() - state.startTime;
            const isCorrect = (userChoice === 'Real' && currentItem.isReal) || (userChoice === 'Fake' && !currentItem.isReal);
            state.results.push({
                id: currentItem.id,
                headline: currentItem.headline,
                userChoice,
                isCorrect,
                timeTaken,
                wasReal: currentItem.isReal
            });
            if (state.currentQuestionIndex < state.testItems.length - 1) {
                state.currentQuestionIndex++;
                state.startTime = Date.now();
                render();
            } else {
                endTest();
            }
        }
        function endTest() {
            state.gameState = 'results';
            render();
        }
        function showHistory() {
            state.gameState = 'history';
            state.scoreHistory = [];
            state.loading = false;
            render();
        }
        // Renders
        function renderLoading() {
            return `
                <div class="flex flex-col items-center justify-center p-8 bg-white card rounded-xl">
                    <div class="h-8 w-8 bg-indigo-500 rounded-full mb-4"></div>
                    <p class="text-lg text-gray-700 font-semibold">Loading Game...</p>
                </div>
            `;
        }
        function renderWelcome() {
            return `
                <div class="p-8 bg-white card rounded-xl">
                    <h1 class="text-3xl font-extrabold text-gray-900 mb-4 text-center">Fake News Detector Challenge</h1>
                    <p class="text-gray-600 mb-6 text-center">Test your media literacy skills! You will be presented with 10 random headlines. For each one, quickly determine if it is <b>Real</b> or <b>Fake</b> news.</p>
                    <div class="space-y-3">
                        <p class="text-sm text-gray-500">Total Questions: <span class="font-semibold text-gray-700">10</span></p>
                        <p class="text-sm text-gray-500">Goal: Achieve high accuracy in the shortest time possible.</p>
                    </div>
                    <button onclick="window.startTest()" class="mt-8 w-full py-3 px-6 bg-indigo-600 text-white font-bold rounded-lg btn-primary hover:bg-indigo-700">Start Challenge</button>
                </div>
            `;
        }
        function renderTesting() {
            const currentItem = state.testItems[state.currentQuestionIndex];
            if (!currentItem || typeof currentItem.headline !== 'string') {
                return `<div class="p-8 bg-white card rounded-xl"><h2 class="text-red-600">Error: No valid data for this question. Please try again, or contact the admin.</h2></div>`;
            }
            const currentNumber = state.currentQuestionIndex + 1;
            const total = state.testItems.length;
            return `
                <div class="p-8 bg-white card rounded-xl">
                    <div class="flex justify-between items-center mb-6 border-b pb-4">
                        <h2 class="text-xl font-bold text-indigo-600">Question ${currentNumber} of ${total}</h2>
                        <div class="text-sm text-gray-600">Time: <span id="timerDisplay" class="font-mono font-bold">00:00.00</span></div>
                    </div>
                    <div class="news-item bg-gray-50 p-6 rounded-lg border-2 border-gray-200 mb-8 flex items-center justify-center">
                        <p class="text-2xl font-extrabold text-gray-800 text-center leading-snug">${currentItem.headline}</p>
                    </div>
                    <div class="flex space-x-4">
                        <button onclick="window.handleAnswer('Fake')" class="flex-1 py-4 bg-red-500 text-white text-xl font-bold rounded-lg btn-primary hover:bg-red-600">Fake News</button>
                        <button onclick="window.handleAnswer('Real')" class="flex-1 py-4 bg-green-500 text-white text-xl font-bold rounded-lg btn-primary hover:bg-green-600">Real News</button>
                    </div>
                    <p class="mt-4 text-center text-xs text-gray-400">Choose carefully. Your speed and accuracy are being recorded.</p>
                </div>
            `;
        }
        function renderResults() {
            const totalTimeMs = Date.now() - state.totalTestStartTime;
            const correctAnswers = state.results.filter(r => r.isCorrect).length;
            const totalQuestions = state.testItems.length;
            const accuracy = ((correctAnswers / totalQuestions) * 100).toFixed(1);
            return `
                <div class="p-8 bg-white card rounded-xl">
                    <h1 class="text-4xl font-extrabold text-center mb-6 text-indigo-600">Challenge Complete!</h1>
                    <div class="space-y-4 text-center mb-8">
                        <div class="text-5xl font-extrabold text-gray-900">${correctAnswers} / ${totalQuestions}</div>
                        <p class="text-xl text-gray-600">Accuracy: <span class="font-bold text-success">${accuracy}%</span></p>
                        <p class="text-xl text-gray-600">Total Time: <span class="font-bold text-gray-900">${formatTime(totalTimeMs)}</span></p>
                    </div>
                    <h2 class="text-xl font-bold text-gray-800 border-b pb-2 mb-4">Detailed Results</h2>
                    <div class="max-h-60 overflow-y-auto space-y-3 pr-2">
                        ${state.results.map((result, index) => `
                        <div class="p-3 rounded-lg flex items-center justify-between ${result.isCorrect ? 'bg-green-50' : 'bg-red-50'}">
                            <span class="text-sm font-semibold flex-1 mr-3 text-gray-800">${index + 1}. ${result.headline.substring(0, 40)}...</span>
                            <span class="text-xs text-right w-1/4">
                                <span class="font-bold block">${result.isCorrect ? 'Correct' : 'Incorrect'}</span>
                                <span class="text-gray-500 block">${formatTime(result.timeTaken)}</span>
                            </span>
                        </div>
                        `).join('')}
                    </div>
                    <div class="mt-8 space-y-3">
                        <button onclick="window.startTest()" class="w-full py-3 bg-indigo-600 text-white font-bold rounded-lg btn-primary hover:bg-indigo-700">Try Again</button>
                    </div>
                </div>
            `;
        }
        function render() {
            let content = '';
            if (state.gameState === 'loading') {
                content = renderLoading();
            } else if (state.gameState === 'welcome') {
                content = renderWelcome();
            } else if (state.gameState === 'testing') {
                content = renderTesting();
                if (!window.timerInterval) {
                    window.timerInterval = setInterval(() => {
                        const timerDisplay = document.getElementById('timerDisplay');
                        if (timerDisplay) {
                            const elapsed = Date.now() - state.startTime;
                            timerDisplay.textContent = formatTime(elapsed);
                        } else if (state.gameState !== 'testing') {
                            clearInterval(window.timerInterval);
                            window.timerInterval = null;
                        }
                    }, 50);
                }
            } else if (state.gameState === 'results') {
                content = renderResults();
                if (window.timerInterval) {
                    clearInterval(window.timerInterval);
                    window.timerInterval = null;
                }
            } else {
                content = renderLoading();
            }
            appDiv.innerHTML = content;
        }
        // --- Initialization (Demo Mode Patch) ---
        function startWithoutFirebase() {
            generateTestItems(10);
            state.loading = false;
            state.gameState = 'welcome';
            render();
        }
        window.state = state;
        window.render = render;
        window.startTest = startTest;
        window.handleAnswer = handleAnswer;
        window.showHistory = showHistory;
        startWithoutFirebase();
    </script>
</body>
</html>
